# T√©cnicas de Extra√ß√£o de Informa√ß√µes de Medicamentos

Documenta√ß√£o completa das t√©cnicas implementadas para extrair dados de medicamentos de p√°ginas web.

---

## üìã Vis√£o Geral

O sistema utiliza uma abordagem **multi-estrat√©gia** que combina:
1. Download de arquivos de bula
2. Simula√ß√£o de sele√ß√£o humana de texto
3. Busca inteligente por padr√µes (Regex)
4. An√°lise com IA (OpenAI)
5. Combina√ß√£o e valida√ß√£o de resultados

---

## üîç ETAPA 1: Navega√ß√£o e Busca de Arquivos

### Objetivo
Identificar e baixar arquivos de bula dispon√≠veis na p√°gina.

### T√©cnica: `findBulaDownloadLinks()`
```typescript
// Padr√µes de busca de links
const linkPatterns = [
  /href=["']([^"']*bula[^"']*)["']/gi,      // Links com "bula"
  /href=["']([^"']*\.pdf[^"']*)["']/gi,     // Arquivos PDF
  /href=["']([^"']*download[^"']*)["']/gi,  // Links de download
  /data-url=["']([^"']*bula[^"']*)["']/gi,  // Atributos data-url
];
```

### Caracter√≠sticas
- ‚úÖ Busca m√∫ltiplos padr√µes de links
- ‚úÖ Converte URLs relativas para absolutas
- ‚úÖ Remove duplicatas
- ‚úÖ Prioriza arquivos com "bula" no nome

### Resultado
```typescript
// Exemplo de retorno
[
  "https://example.com/bula-medicamento.pdf",
  "https://example.com/downloads/bula_completa.pdf"
]
```

---

## üì• Download de Arquivos: `downloadAndExtractPDF()`

### T√©cnica
```typescript
const response = await fetch(url, {
  headers: {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
  },
  signal: AbortSignal.timeout(15000)
});
```

### Caracter√≠sticas
- ‚úÖ Timeout de 15 segundos
- ‚úÖ User-Agent de navegador real
- ‚úÖ Detecta tipo de conte√∫do (PDF vs HTML)
- ‚úÖ Extra√ß√£o de texto quando poss√≠vel
- ‚ö†Ô∏è Limita√ß√£o: PDFs requerem processamento adicional

---

## üñ±Ô∏è ETAPA 2: Simula√ß√£o de Sele√ß√£o com Mouse

### Objetivo
Capturar TODO o conte√∫do vis√≠vel da p√°gina como um usu√°rio faria (Ctrl+A).

### T√©cnica: `simulateTextSelection()`

#### Estrat√©gias de Captura (em ordem de prioridade)
1. **Sele√ß√£o de tela completa desktop**
2. **Sele√ß√£o de tela completa mobile**
3. **Sele√ß√£o do body completo**
4. **Sele√ß√£o de conte√∫do principal**

### Simula√ß√£o de Comportamento Humano
```typescript
// Delay aleat√≥rio simulando carregamento
const loadDelay = 3000 + Math.random() * 2000;
await new Promise(resolve => setTimeout(resolve, loadDelay));
```

### Headers de Navegador Real
```typescript
headers: {
  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
  'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
  'Accept-Language': 'pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7',
  'Accept-Encoding': 'gzip, deflate, br',
  'Connection': 'keep-alive',
  'Upgrade-Insecure-Requests': '1',
  'Sec-Fetch-Dest': 'document',
  'Sec-Fetch-Mode': 'navigate',
  'Sec-Fetch-Site': 'none',
  'Cache-Control': 'max-age=0'
}
```

### Caracter√≠sticas
- ‚úÖ M√∫ltiplas tentativas com fallback
- ‚úÖ Timeout de 15 segundos por tentativa
- ‚úÖ Simula comportamento humano
- ‚úÖ HTTPS com fallback para HTTP

---

## üìã ETAPA 3: C√≥pia para Arquivo Tempor√°rio

### T√©cnica: `simulateSaveToTempFile()`

### Caracter√≠sticas
```typescript
const tempFileName = `temp_medicamento_${Date.now()}.txt`;
```

- ‚úÖ Nome √∫nico baseado em timestamp
- ‚úÖ Preview dos primeiros 1000 chars
- ‚úÖ Preview dos √∫ltimos 500 chars
- ‚úÖ Logging detalhado para debug

---

## üìñ ETAPA 4: Limpeza CONSERVADORA de HTML

### Objetivo
Extrair texto vis√≠vel preservando o M√ÅXIMO de estrutura e contexto.

### T√©cnica: `extractVisibleText()`

#### 1. Convers√£o de Tags Estruturais
```typescript
text = html
  .replace(/<br\s*\/?>/gi, '\n')
  .replace(/<\/p>/gi, '\n\n')
  .replace(/<\/div>/gi, '\n')
  .replace(/<\/h[1-6]>/gi, '\n\n')
  .replace(/<\/li>/gi, '\n')
  .replace(/<\/tr>/gi, '\n')
  .replace(/<\/td>/gi, ' | ')
  .replace(/<\/th>/gi, ' | ');
```

#### 2. Remo√ß√£o Seletiva
```typescript
text = text
  .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')  // Scripts
  .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')    // Estilos
  .replace(/<!--[\s\S]*?-->/g, '');                   // Coment√°rios
```

#### 3. Normaliza√ß√£o de Espa√ßos
```typescript
text = text
  .replace(/[ \t]+/g, ' ')           // M√∫ltiplos espa√ßos ‚Üí 1
  .replace(/\n\s+\n/g, '\n\n')       // Linhas vazias
  .replace(/\n{3,}/g, '\n\n')        // M√°ximo 2 quebras
  .trim();
```

#### 4. Decodifica√ß√£o de Entidades HTML
```typescript
text = text
  .replace(/&nbsp;/g, ' ')
  .replace(/&amp;/g, '&')
  .replace(/&aacute;/g, '√°')
  .replace(/&eacute;/g, '√©')
  // ... etc
```

### Caracter√≠sticas
- ‚úÖ Preserva estrutura de tabelas
- ‚úÖ Mant√©m quebras de linha importantes
- ‚úÖ Remove apenas o essencial
- ‚úÖ Preserva ~70-90% do conte√∫do original
- ‚úÖ Suporte completo a portugu√™s (acentos)

---

## üîç ETAPA 5: Busca Inteligente por Padr√µes

### Objetivo
Extrair dados estruturados usando regex antes da IA.

### T√©cnica: `findMedicationPatterns()`

#### Padr√µes Implementados

##### 1. Nome do Medicamento
```typescript
const namePatterns = [
  /([A-Z√Ä√Å√Ç√É√Ñ√Ö√Ü√á√à√â√ä√ã√å√ç√é√è√ê√ë√í√ì√î√ï√ñ√ò√ô√ö√õ√ú√ù√û][a-z√†√°√¢√£√§√•√¶√ß√®√©√™√´√¨√≠√Æ√Ø√∞√±√≤√≥√¥√µ√∂√∏√π√∫√ª√º√Ω√æ]+)\s*\d+\s*mg/i,
  /([A-Z√Ä√Å√Ç√É√Ñ√Ö√Ü√á√à√â√ä√ã√å√ç√é√è√ê√ë√í√ì√î√ï√ñ√ò√ô√ö√õ√ú√ù√û][a-z√†√°√¢√£√§√•√¶√ß√®√©√™√´√¨√≠√Æ√Ø√∞√±√≤√≥√¥√µ√∂√∏√π√∫√ª√º√Ω√æ]+)\s*\d+mg/i,
  /medicamento[:\s]+([A-Z][a-z]+)/i,
];
```

##### 2. Concentra√ß√£o/Dosagem
```typescript
const concPatterns = [
  /(\d+\s*mg(?:\/mL)?)/i,  // Miligramas
  /(\d+\s*mcg)/i,          // Microgramas
  /(\d+\s*%)/i,            // Porcentagem
  /(\d+\s*UI)/i,           // Unidades Internacionais
];
```

##### 3. Forma Farmac√™utica
```typescript
const formPatterns = [
  /(comprimido(?:s)?(?:\s+sublingual(?:is)?)?)/i,
  /(c√°psula(?:s)?)/i,
  /(solu√ß√£o(?:\s+oral)?)/i,
  /(pomada)/i,
  /(xarope)/i,
  /(suspens√£o)/i,
];
```

##### 4. Fabricante
```typescript
const manuPatterns = [
  /(?:fabricante|laborat√≥rio)[:\s]+([A-Z][a-z√†-√ø]+(?:\s+[A-Z][a-z√†-√ø]+)*)/i,
  /\b(EMS|Medley|Eurofarma|Teuto|Germed|Ach√©|Neo Qu√≠mica|Pfizer|Novartis|Bayer)\b/i,
];
```

### Caracter√≠sticas
- ‚úÖ Busca din√¢mica e adapt√°vel
- ‚úÖ Suporte a m√∫ltiplos formatos
- ‚úÖ Normaliza√ß√£o de resultados
- ‚úÖ Logging detalhado de matches

---

## ü§ñ ETAPA 6: An√°lise com IA

### Objetivo
Usar OpenAI GPT-4o-mini para extrair informa√ß√µes complexas.

### T√©cnica: `analyzeWithAI()`

#### Configura√ß√£o
```typescript
{
  model: 'gpt-4o-mini',
  messages: [{
    role: 'system',
    content: 'Voc√™ √© um especialista em medicamentos. Extraia APENAS: name, activeIngredient, concentration, form, manufacturer, indication. Retorne JSON puro sem markdown.'
  }, {
    role: 'user',
    content: `Analise este texto e extraia informa√ß√µes do medicamento:\n\n${text.substring(0, 8000)}`
  }],
  temperature: 0.2,
  max_tokens: 500
}
```

### Caracter√≠sticas
- ‚úÖ Temperatura baixa (0.2) para consist√™ncia
- ‚úÖ Limite de 8000 chars de entrada
- ‚úÖ Limite de 500 tokens de sa√≠da
- ‚úÖ Sistema prompt especializado
- ‚úÖ Extra√ß√£o de JSON robusto (com regex fallback)

#### Parse Robusto de JSON
```typescript
const jsonMatch = content.match(/\{[\s\S]*\}/);
const result = jsonMatch ? JSON.parse(jsonMatch[0]) : {};
```

### Campos Extra√≠dos pela IA
- `name` - Nome do medicamento
- `activeIngredient` - Princ√≠pio ativo
- `concentration` - Concentra√ß√£o
- `form` - Forma farmac√™utica
- `manufacturer` - Fabricante
- `indication` - Indica√ß√£o terap√™utica

---

## üîß ETAPA 7: Combina√ß√£o de Resultados

### Objetivo
Mesclar dados de regex e IA, priorizando os mais confi√°veis.

### T√©cnica: `combineResults()`

#### Estrat√©gia de Merge
```typescript
const combined = {
  name: patterns.name || aiData.name || null,
  activeIngredient: aiData.activeIngredient || null,
  manufacturer: patterns.manufacturer || aiData.manufacturer || null,
  concentration: patterns.concentration || aiData.concentration || null,
  form: patterns.form || aiData.form || null,
  route: patterns.route || aiData.route || null,
  category: aiData.category || null,
  indication: aiData.indication || null,
};
```

### Prioriza√ß√£o
1. **Dados estruturados (regex)** - Para campos num√©ricos/simples
   - Nome (se encontrado com dosagem)
   - Concentra√ß√£o
   - Forma farmac√™utica
   
2. **Dados da IA** - Para campos complexos
   - Princ√≠pio ativo
   - Indica√ß√£o terap√™utica
   - Categoria

### Fallback
```typescript
if (!combined.name && !combined.concentration && !combined.manufacturer) {
  combined.name = 'Medicamento n√£o identificado';
  combined.note = 'N√£o foi poss√≠vel extrair dados do texto';
}
```

---

## üìä C√°lculo de Confian√ßa

### F√≥rmula
```typescript
const fieldsCount = Object.values(finalData)
  .filter(v => v && v !== 'Medicamento n√£o identificado').length;

const confidence = Math.min(95, Math.max(40, (fieldsCount / 10) * 100));
```

### Escala
- **90-95%**: 9+ campos preenchidos
- **70-89%**: 7-8 campos preenchidos
- **50-69%**: 5-6 campos preenchidos
- **40-49%**: 4 ou menos campos

---

## üéØ Resultado Final

### Estrutura de Resposta
```typescript
{
  success: true,
  data: {
    name: "Dipirona S√≥dica",
    activeIngredient: "Dipirona s√≥dica",
    manufacturer: "EMS",
    concentration: "500mg",
    form: "Comprimido",
    route: "Oral",
    indication: "Analg√©sico e antit√©rmico",
    // ... outros campos
  },
  confidence: 85,
  method: 'mouse_text_selection',
  originalUrl: "https://...",
  textSelectionSimulated: true,
  debug: {
    buscaInteligente: {
      success: true,
      metodo: 'combinacao_ia_padroes'
    }
  }
}
```

---

## ‚ö° Fluxo Completo

```mermaid
graph TD
    A[URL recebida] --> B[Buscar arquivos de bula]
    B --> C[Download de PDFs/bulas]
    C --> D[Simular sele√ß√£o de texto Ctrl+A]
    D --> E[Salvar em arquivo tempor√°rio]
    E --> F[Limpar HTML conservadoramente]
    F --> G[Busca por padr√µes regex]
    F --> H[An√°lise com IA GPT-4o-mini]
    G --> I[Combinar resultados]
    H --> I
    C --> I
    I --> J[Calcular confian√ßa]
    J --> K[Retornar dados estruturados]
```

---

## üõ†Ô∏è T√©cnicas Aplicadas - Resumo

| T√©cnica | Objetivo | Status |
|---------|----------|--------|
| **Busca de arquivos** | Encontrar bulas para download | ‚úÖ Implementado |
| **Download de PDFs** | Extrair conte√∫do de arquivos | ‚ö†Ô∏è Parcial (texto apenas) |
| **Simula√ß√£o humana** | Evitar bloqueios anti-bot | ‚úÖ Implementado |
| **Sele√ß√£o Ctrl+A** | Capturar p√°gina completa | ‚úÖ Implementado |
| **Limpeza conservadora** | Preservar contexto | ‚úÖ Implementado |
| **Regex din√¢mico** | Extra√ß√£o estruturada r√°pida | ‚úÖ Implementado |
| **IA (OpenAI)** | An√°lise sem√¢ntica avan√ßada | ‚úÖ Implementado |
| **Combina√ß√£o inteligente** | Merge de m√∫ltiplas fontes | ‚úÖ Implementado |
| **Fallback robusto** | Tratamento de falhas | ‚úÖ Implementado |

---

## üîÑ Melhorias Futuras Poss√≠veis

1. **Extra√ß√£o de PDF verdadeira**
   - Adicionar biblioteca de parse de PDF
   - Extrair tabelas e imagens de bulas

2. **OCR para imagens**
   - Processar screenshots de p√°ginas
   - Extrair texto de imagens de bulas

3. **Cache de resultados**
   - Evitar reprocessamento de URLs conhecidas
   - Banco de dados de medicamentos

4. **Valida√ß√£o cruzada**
   - Comparar com bases oficiais (Anvisa)
   - Validar c√≥digos de barras GS1

5. **Melhor tratamento de JavaScript**
   - Renderizar p√°ginas SPA
   - Executar JavaScript para conte√∫do din√¢mico

---

## üìù Notas de Implementa√ß√£o

### Logs e Debug
Cada etapa gera logs detalhados:
```
üîó Navegando para URL: https://...
üìÑ Found potential bula link: https://.../bula.pdf
üñ±Ô∏è Simulando Ctrl+C...
üìè 12000 ‚Üí 8500 chars (70.8% preservado)
üíä Nome encontrado: Dipirona
‚öñÔ∏è Concentra√ß√£o encontrada: 500mg
ü§ñ An√°lise IA conclu√≠da
üéØ Confian√ßa final: 85%
```

### Tratamento de Erros
- ‚úÖ Timeout em todas as requisi√ß√µes
- ‚úÖ Fallback entre estrat√©gias
- ‚úÖ Continua√ß√£o mesmo com falhas parciais
- ‚úÖ Retorno de dados parciais quando poss√≠vel

---

**√öltima atualiza√ß√£o**: Janeiro 2025  
**Vers√£o**: 2.0  
**Status**: Produ√ß√£o
